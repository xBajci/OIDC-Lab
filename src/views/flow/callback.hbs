<div class="max-w-4xl mx-auto">
  <div class="sm:flex sm:items-center sm:justify-between mb-6">
    <h1 class="text-2xl font-bold text-gray-900">{{title}}</h1>
    <a href="/flow" class="text-sm text-gray-500 hover:text-gray-700">&larr; Start new flow</a>
  </div>

  {{#if error}}
  <div class="bg-red-50 border border-red-200 rounded-lg p-6 mb-6">
    <h2 class="text-lg font-medium text-red-800 mb-2">Error</h2>
    <p class="text-red-700">{{error}}</p>
    {{#if errorDescription}}
    <p class="text-red-600 mt-2">{{errorDescription}}</p>
    {{/if}}
    {{#if errorStack}}
    <pre class="mt-4 p-4 bg-red-100 rounded text-sm overflow-x-auto">{{errorStack}}</pre>
    {{/if}}
  </div>
  {{else}}

  <!-- Flow Info -->
  <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
    <dl class="grid grid-cols-2 gap-4 text-sm">
      <div>
        <dt class="text-gray-500">Issuer</dt>
        <dd class="font-medium">{{issuer}}</dd>
      </div>
      <div>
        <dt class="text-gray-500">Client ID</dt>
        <dd class="font-medium font-mono">{{clientId}}</dd>
      </div>
    </dl>
    {{#if wasRefreshed}}
    <div class="mt-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
      Refreshed -- these tokens were obtained via refresh_token grant
    </div>
    {{/if}}
  </div>

  <!-- Raw Tokens -->
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4">Raw Tokens</h2>
    
    <div class="space-y-4">
      {{#if tokens.accessToken}}
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Access Token</label>
        <div class="relative">
          <textarea
            readonly
            class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 font-mono text-xs break-all"
            rows="3"
          >{{tokens.accessToken}}</textarea>
        </div>
        <div class="flex gap-4 mt-1 text-sm text-gray-500">
          {{#if tokens.tokenType}}<span>Type: {{tokens.tokenType}}</span>{{/if}}
          {{#if tokens.expiresIn}}<span>Expires in: {{tokens.expiresIn}}s</span>{{/if}}
        </div>
      </div>
      {{/if}}

      {{#if tokens.idToken}}
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ID Token</label>
        <textarea
          readonly
          class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 font-mono text-xs break-all"
          rows="3"
        >{{tokens.idToken}}</textarea>
      </div>
      {{/if}}

      {{#if tokens.refreshToken}}
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Refresh Token</label>
        <textarea
          readonly
          class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 font-mono text-xs break-all"
          rows="2"
        >{{tokens.refreshToken}}</textarea>
        <form action="/flow/refresh" method="POST" class="mt-2">
          <input type="hidden" name="refreshToken" value="{{tokens.refreshToken}}">
          <input type="hidden" name="issuer" value="{{issuer}}">
          <input type="hidden" name="clientId" value="{{clientId}}">
          <input type="hidden" name="clientSecret" value="{{clientSecret}}">
          <button
            type="submit"
            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Refresh Tokens
          </button>
          <p class="mt-1 text-xs text-gray-500">Exchange this refresh token for a new access token (and possibly a new refresh token)</p>
        </form>
      </div>
      {{/if}}
    </div>
  </div>

  <!-- Decoded ID Token -->
  {{#if idTokenDecoded}}
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4">Decoded ID Token</h2>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Header</label>
        <pre class="p-3 border border-gray-300 rounded-md bg-gray-50 font-mono text-xs overflow-x-auto">{{json idTokenDecoded.header}}</pre>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Payload</label>
        <pre class="p-3 border border-gray-300 rounded-md bg-gray-50 font-mono text-xs overflow-x-auto">{{json idTokenDecoded.payload}}</pre>
      </div>
    </div>
  </div>
  {{/if}}

  <!-- Token Introspection -->
  {{#if introspection}}
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4">Token Introspection</h2>
    <pre class="p-3 border border-gray-300 rounded-md bg-gray-50 font-mono text-xs overflow-x-auto">{{json introspection}}</pre>
  </div>
  {{/if}}

  <!-- UserInfo -->
  {{#if userinfo}}
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4">UserInfo Response</h2>
    <pre class="p-3 border border-gray-300 rounded-md bg-gray-50 font-mono text-xs overflow-x-auto">{{json userinfo}}</pre>
  </div>
  {{/if}}

  <!-- Session Management -->
  <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4">Session Management</h2>
    
    <div class="flex items-center gap-3 mb-4">
      <span class="text-sm font-medium text-gray-700">Token Status:</span>
      {{#if introspection}}
        {{#if introspection.active}}
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
          Active
        </span>
        {{else}}
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
          Inactive
        </span>
        {{/if}}
      {{else}}
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
          Not checked
        </span>
      {{/if}}
      
      {{#if revoked}}
      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
        Tokens Revoked
      </span>
      {{/if}}
    </div>

    <div class="flex flex-wrap gap-3 mb-4">
      <!-- Introspect Button -->
      <form action="/flow/introspect" method="POST">
        <input type="hidden" name="accessToken" value="{{tokens.accessToken}}">
        <input type="hidden" name="idToken" value="{{tokens.idToken}}">
        <input type="hidden" name="refreshToken" value="{{tokens.refreshToken}}">
        <input type="hidden" name="issuer" value="{{issuer}}">
        <input type="hidden" name="clientId" value="{{clientId}}">
        <input type="hidden" name="clientSecret" value="{{clientSecret}}">
        <button
          type="submit"
          class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
        >
          <svg class="h-4 w-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          Introspect
        </button>
      </form>

      <!-- Revoke Button -->
      <form action="/flow/revoke" method="POST">
        <input type="hidden" name="accessToken" value="{{tokens.accessToken}}">
        <input type="hidden" name="idToken" value="{{tokens.idToken}}">
        <input type="hidden" name="refreshToken" value="{{tokens.refreshToken}}">
        <input type="hidden" name="issuer" value="{{issuer}}">
        <input type="hidden" name="clientId" value="{{clientId}}">
        <input type="hidden" name="clientSecret" value="{{clientSecret}}">
        <button
          type="submit"
          class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
        >
          <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
          Revoke Tokens
        </button>
      </form>

      <!-- End Session Button -->
      <form action="/flow/end-session" method="POST">
        <input type="hidden" name="idToken" value="{{tokens.idToken}}">
        <input type="hidden" name="issuer" value="{{issuer}}">
        <input type="hidden" name="clientId" value="{{clientId}}">
        <input type="hidden" name="clientSecret" value="{{clientSecret}}">
        <button
          type="submit"
          class="inline-flex items-center px-4 py-2 border border-red-300 rounded-md shadow-sm text-sm font-medium text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
        >
          <svg class="h-4 w-4 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
          </svg>
          End Server Session
        </button>
      </form>

      <!-- Local Logout Button -->
      <form action="/flow/local-logout" method="POST">
        <button
          type="submit"
          class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
        >
          <svg class="h-4 w-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          Clear Local Session
        </button>
      </form>
    </div>

    <div class="text-sm text-gray-600 bg-white p-3 rounded border border-gray-200">
      <strong class="text-gray-800">What do these do?</strong>
      <ul class="mt-2 space-y-1 list-disc list-inside">
        <li><strong>Introspect</strong> &mdash; Check if the token is still valid at the server (calls <code>/token/introspect</code>)</li>
        <li><strong>Revoke Tokens</strong> &mdash; Invalidates your tokens at the server but the <strong>OP session stays alive</strong>. After revoking, click Introspect to see <code>active: false</code>. Then start a new flow &mdash; you won't need to re-login because the OP session cookie is still valid.</li>
        <li><strong>End Server Session</strong> &mdash; RP-Initiated Logout. Kills the OP session via <code>/session/end</code> and redirects back here. After this, you'll need to login again.</li>
        <li><strong>Clear Local Session</strong> &mdash; Just clears your client app session. The OP session and tokens remain valid.</li>
      </ul>
    </div>
  </div>

  {{/if}}

  <div class="flex justify-center mt-6">
    <a href="/flow" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">
      &larr; Start Another Flow
    </a>
  </div>
</div>
